# Streamlit Dashboard Build and Deploy Pipeline
#
# This pipeline builds the Streamlit dashboard Docker image and deploys it to the server.
# It uses Docker socket mounting to build directly on the server (no SSH needed).
#
# Build Process:
# 1. Build Docker image from web_dashboard/Dockerfile
# 2. Tag image with commit SHA for version tracking
# 3. Stop and remove existing container (if running)
# 4. Deploy new container with environment variables from Woodpecker secrets
#
# Available Secrets (configure in Woodpecker):
# - SUPABASE_URL: Your Supabase project URL
# - SUPABASE_PUBLISHABLE_KEY: For user authentication
# - SUPABASE_SECRET_KEY: For admin scripts and debug operations
#
# Note: Repository must be marked as "Trusted" in Woodpecker settings to use volumes

steps:
  build-and-deploy:
    image: docker:24
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      TZ: America/Vancouver
    commands:
      # Set timezone (Pacific Time - handles PST/PDT automatically)
      - ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
      
      # Build Docker image from web_dashboard/Dockerfile
      - docker build -f web_dashboard/Dockerfile -t trading-dashboard:latest .
      - docker tag trading-dashboard:latest trading-dashboard:${CI_COMMIT_SHA}
      
      # Stop and remove existing container if it exists
      - docker stop trading-dashboard || true
      - docker rm trading-dashboard || true
      
      # Deploy new container with environment variables from Woodpecker secrets
      - docker run -d \
        --name trading-dashboard \
        --restart unless-stopped \
        -p 8501:8501 \
        -e SUPABASE_URL=${SUPABASE_URL} \
        -e SUPABASE_PUBLISHABLE_KEY=${SUPABASE_PUBLISHABLE_KEY} \
        -e SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY} \
        -e STREAMLIT_SERVER_HEADLESS=true \
        -e STREAMLIT_BROWSER_GATHER_USAGE_STATS=false \
        trading-dashboard:latest
      
      - echo "âœ… Build and deployment complete!"
    when:
      event: push
      branch: [main, master]


