# Caddyfile Example
# Copy this to Caddyfile and set APP_DOMAIN environment variable
# Example: export APP_DOMAIN=your-domain.com

{$APP_DOMAIN} {
    # Optional: bind to specific interface (from user config)
    # bind 192.168.100.69

    # Serve auth callback HTML (handles magic links & password resets)
    handle /auth_callback.html {
        root * /ai-trading/frontend
        file_server
    }
    
    # Serve set_cookie.html (sets auth cookie and redirects back)
    handle /set_cookie.html {
        root * /ai-trading/frontend
        file_server
    }
    
    # Serve login.html (simple HTML login form for browser automation)
    handle /login.html {
        root * /ai-trading/frontend
        file_server
    }
    
    # Serve Research PDF files (static file server)
    handle_path /research/* {
        root * /ai-trading/research
        file_server browse
        # Optional: Add cache headers for PDFs
        header Cache-Control "public, max-age=3600"
    }

	# v2 pages - route to Flask (migrated from Streamlit)
	handle /v2/* {
        reverse_proxy localhost:5001 {
            # Add trusted proxies if behind Cloudflare
            trusted_proxies private_ranges
            # User provided trusted proxies (Cloudflare IPs)
            trusted_proxies 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
        }
	}

	# API endpoints - route to Flask
    # Required for form submissions and toggles
	handle /api/* {
        reverse_proxy localhost:5001 {
            trusted_proxies private_ranges
            trusted_proxies 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
        }
	}

	# Fix Streamlit asset loading when accessed from /pages/ subpaths
	# Browser resolves assets like ./static/js/... relative to /pages/, creating 404s
	# This regex strips /pages/ from the path for assets, components, and vendor files
	@items_in_pages {
		path_regexp pages_assets ^/pages/(static|vendor|component|favicon\.png|manifest\.json)(.*)$
	}
	handle @items_in_pages {
		rewrite * /{re.pages_assets.1}{re.pages_assets.2}
		reverse_proxy localhost:8501
	}


    # Flask Static Assets (Theme CSS etc)
    # Routed to /assets to avoid conflict with Streamlit's /static
    handle /assets/* {
        reverse_proxy localhost:5001 {
            trusted_proxies private_ranges
        }
    }
    
	# Redirect /pages/*.py to /pages/* (strip .py extension) - STREAMLIT ONLY
	# This prevents issues when accessing Streamlit pages directly with .py extension
	# Note: This only affects /pages/* paths (Streamlit), not /v2/* (Flask)
	# Streamlit handles pages without .py extension in the URL
	route /pages/*.py {
		uri strip_suffix .py
		redir {path} permanent
	}
    
	# Streamlit static files - must be before general reverse_proxy
	# This ensures JS/CSS files are served with correct MIME types
	# CRITICAL: This handler must come before the general reverse_proxy
	# to ensure static files are always served correctly, even during errors
    handle /static/* {
        reverse_proxy localhost:8501 {
            header_up Host {host}
        }
        # Streamlit sets Cache-Control headers, we preserve them
    }
    
	# WebSocket endpoint - must be before general reverse_proxy
    handle /_stcore/stream {
        reverse_proxy localhost:8501 {
            transport http {
                versions 1.1 2
            }
        }
    }

	# Fix Streamlit health/stream paths - Hybrid Safe Matcher
	# 1. path glob: Ensures we NEVER match normal pages (Safety)
	# 2. path_regexp: Extracts the /_stcore/... part for the rewrite (Functionality)
	@stcore_safe {
		path */_stcore/health */_stcore/host-config */_stcore/stream
		path_regexp stcore_capture (/_stcore/.*)$
	}
	handle @stcore_safe {
		rewrite * {re.stcore_capture.1}
		reverse_proxy localhost:8501 {
			transport http {
				versions 1.1 2
			}
		}
	}
	
	# Health check endpoint
    handle /health {
        reverse_proxy localhost:8501
    }

	# Serve logs (optional)
    handle_path /logs/* {
        root * /srv/logs
        file_server browse
    }
	
	# Reverse proxy everything else to Streamlit (Default)
    reverse_proxy localhost:8501 {
        # WebSocket support for Streamlit
        transport http {
            versions 1.1 2
        }
		trusted_proxies private_ranges
        trusted_proxies 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
    }
}
