# Cookie Refresher Sidecar Container
# ====================================
# 
# This container runs independently to refresh WebAI cookies using Playwright.
# It writes refreshed cookies to a shared volume that the main app can read.
#
# Build: docker build -f web_dashboard/Dockerfile.cookie-refresher -t cookie-refresher:latest .
# Run: docker run -d --name cookie-refresher --restart unless-stopped -v /shared/cookies:/shared/cookies cookie-refresher:latest

FROM python:3.11-slim

# Install system dependencies for Playwright and uv
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    gnupg \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libwayland-client0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    xdg-utils \
    gcc \
    curl \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && test -f /root/.local/bin/uv || (echo "uv installation failed" && exit 1) \
    && rm -rf /var/lib/apt/lists/*

# Add uv to PATH
ENV PATH="/root/.local/bin:${PATH}"

# Set working directory
WORKDIR /app

# Copy requirements first (for better caching)
COPY web_dashboard/requirements.txt ./requirements.txt

# Install Python dependencies with uv (much faster than pip)
RUN /root/.local/bin/uv pip install --system --no-cache -r requirements.txt && \
    /root/.local/bin/uv pip install --system --no-cache playwright && \
    playwright install chromium && \
    playwright install-deps chromium

# Copy application code
COPY . .

# Set Python path
ENV PYTHONPATH=/app:/app/web_dashboard
ENV PYTHONUNBUFFERED=1

# Default environment variables
ENV COOKIE_REFRESH_INTERVAL=3600
ENV COOKIE_OUTPUT_FILE=/shared/cookies/webai_cookies.json
ENV COOKIE_INPUT_FILE=/shared/cookies/webai_cookies.json
# AI service URL (must be set via Woodpecker secret ai_service_web_url)
# No default - must be provided via environment variable

# Run the cookie refresher
CMD ["python", "web_dashboard/cookie_refresher.py"]

