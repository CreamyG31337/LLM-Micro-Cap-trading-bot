{% extends "base.html" %}

{% block title %}User Preferences - Portfolio Dashboard{% endblock %}

{% block page_title %}üë§ User Preferences{% endblock %}
{% block page_subtitle %}Configure your dashboard settings{% endblock %}

{% block extra_head %}
<style>
    .card-hover:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease-in-out;
    }

    .success-message {
        background-color: #10b981;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }

    .error-message {
        background-color: #ef4444;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Beta Features -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-hover border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-flask mr-2 text-purple-600"></i>Beta Features
                </h2>
                <p class="text-gray-600 text-sm mt-1">Try experimental features before they're fully released.</p>
            </div>
        </div>

        <div class="mt-4 flex items-center justify-between border-t border-gray-100 pt-4">
            <div>
                <h3 class="font-medium text-gray-900">Use Cloud Pages (Flask)</h3>
                <p class="text-sm text-gray-500">Enable new, faster page implementations for Settings & Logs.</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="v2-toggle" class="sr-only peer" {% if is_v2_enabled %}checked{% endif %}>
                <div
                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
                </div>
            </label>
        </div>
    </div>

    <!-- Timezone Settings -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üåç Timezone</h2>
        <p class="text-gray-600 mb-4">Select your timezone. All times in the dashboard will be displayed in this
            timezone.</p>

        <div class="mb-4">
            <label for="timezone-select" class="block text-sm font-medium text-gray-700 mb-2">Select your
                timezone:</label>
            <select id="timezone-select"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="America/Los_Angeles">America/Los_Angeles - Pacific Time (US & Canada)</option>
                <option value="America/Denver">America/Denver - Mountain Time (US & Canada)</option>
                <option value="America/Chicago">America/Chicago - Central Time (US & Canada)</option>
                <option value="America/New_York">America/New_York - Eastern Time (US & Canada)</option>
                <option value="America/Toronto">America/Toronto - Eastern Time (Canada)</option>
                <option value="America/Vancouver">America/Vancouver - Pacific Time (Canada)</option>
                <option value="UTC">UTC - UTC (Coordinated Universal Time)</option>
                <option value="Europe/London">Europe/London - London (GMT/BST)</option>
                <option value="Europe/Paris">Europe/Paris - Paris (CET/CEST)</option>
                <option value="Asia/Tokyo">Asia/Tokyo - Tokyo (JST)</option>
                <option value="Australia/Sydney">Australia/Sydney - Sydney (AEDT/AEST)</option>
            </select>
        </div>

        <div id="timezone-preview" class="text-sm text-gray-500 mb-4"></div>

        <button id="save-timezone"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
            <i class="fas fa-save mr-2"></i>Save Timezone
        </button>
        <div id="timezone-success" class="success-message">‚úÖ Timezone saved successfully!</div>
        <div id="timezone-error" class="error-message">‚ùå Failed to save timezone. Please try again.</div>
    </div>

    <!-- Currency Settings -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üí∞ Currency</h2>
        <p class="text-gray-600 mb-4">Select your preferred display currency. All values will be converted and
            displayed in this currency.</p>

        <div class="mb-4">
            <label for="currency-select" class="block text-sm font-medium text-gray-700 mb-2">Select your display
                currency:</label>
            <select id="currency-select"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="CAD">CAD - Canadian Dollar</option>
                <option value="USD">USD - US Dollar</option>
            </select>
        </div>

        <button id="save-currency"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
            <i class="fas fa-save mr-2"></i>Save Currency
        </button>
        <div id="currency-success" class="success-message">‚úÖ Currency saved successfully!</div>
        <div id="currency-error" class="error-message">‚ùå Failed to save currency. Please try again.</div>
    </div>

    <!-- Theme Settings -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üé® Theme</h2>
        <p class="text-gray-600 mb-4">Override your browser/system theme preference. 'System Default' follows your
            OS setting.</p>

        <div class="mb-4">
            <label for="theme-select" class="block text-sm font-medium text-gray-700 mb-2">Select your
                theme:</label>
            <select id="theme-select"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="system">System Default</option>
                <option value="dark">Dark Mode</option>
                <option value="light">Light Mode</option>
            </select>
        </div>

        <div id="theme-preview" class="text-sm text-gray-500 mb-4"></div>

        <button id="save-theme"
            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
            <i class="fas fa-save mr-2"></i>Save Theme
        </button>
        <div id="theme-success" class="success-message">‚úÖ Theme saved successfully! Refresh the page to apply the
            theme change.</div>
        <div id="theme-error" class="error-message">‚ùå Failed to save theme. Please try again.</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/assets/js/settings.js"></script>
<script>
    // Initialize page with current preferences
    document.addEventListener('DOMContentLoaded', function () {
        // Set current timezone
        const currentTimezone = '{{ current_timezone }}';
        if (currentTimezone) {
            document.getElementById('timezone-select').value = currentTimezone;
            updateTimezonePreview();
        }

        // Set current currency
        const currentCurrency = '{{ current_currency }}';
        if (currentCurrency) {
            document.getElementById('currency-select').value = currentCurrency;
        }

        // Set current theme
        const currentTheme = '{{ current_theme }}';
        if (currentTheme) {
            document.getElementById('theme-select').value = currentTheme;
            updateThemePreview();
        }

        // V2 Beta Toggle Handler
        const v2Toggle = document.getElementById('v2-toggle');
        if (v2Toggle) {
            v2Toggle.addEventListener('change', async function () {
                const enabled = this.checked;
                try {
                    const response = await fetch('/api/settings/v2_enabled', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ enabled: enabled })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.checked = !enabled; // Revert
                    alert('Failed to update preference. Please try again.');
                }
            });
        }
    });

    function updateTimezonePreview() {
        const tz = document.getElementById('timezone-select').value;
        if (tz) {
            // This would ideally show current time, but requires server-side rendering
            document.getElementById('timezone-preview').textContent = `Selected: ${tz}`;
        }
    }

    function updateThemePreview() {
        const theme = document.getElementById('theme-select').value;
        const preview = document.getElementById('theme-preview');
        if (theme === 'system') {
            preview.textContent = '‚ÑπÔ∏è Theme will follow your browser/OS dark mode setting';
        } else if (theme === 'dark') {
            preview.textContent = 'üåô Dark mode will be forced on';
        } else {
            preview.textContent = '‚òÄÔ∏è Light mode will be forced on';
        }
    }

    document.getElementById('timezone-select').addEventListener('change', updateTimezonePreview);
    document.getElementById('theme-select').addEventListener('change', updateThemePreview);
</script>
{% endblock %}
