{% extends "base.html" %}

{% block title %}User Preferences - Portfolio Dashboard{% endblock %}

{% block page_title %}üë§ User Preferences{% endblock %}
{% block page_subtitle %}Configure your dashboard settings{% endblock %}

{% block extra_head %}
<style>
    .card-hover:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease-in-out;
    }

    .success-message {
        background-color: #10b981;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }

    .error-message {
        background-color: #ef4444;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Beta Features -->
    <div class="bg-dashboard-surface rounded-lg shadow-lg p-6 mb-6 card-hover border-l-4 border-accent">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-text-primary flex items-center">
                    <i class="fas fa-flask mr-2 text-accent"></i>Beta Features
                </h2>
                <p class="text-text-secondary text-sm mt-1">Try experimental features before they're fully released.</p>
            </div>
        </div>

        <div class="mt-4 flex items-center justify-between border-t border-border pt-4">
            <div>
                <h3 class="font-medium text-text-primary">Use Cloud Pages (Flask)</h3>
                <p class="text-sm text-text-secondary">Enable new, faster page implementations across the dashboard.</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="v2-toggle" class="sr-only peer" {% if is_v2_enabled %}checked{% endif %}>
                <div
                    class="w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent">
                </div>
            </label>
        </div>
    </div>

    <!-- Timezone Settings -->
    <div class="bg-dashboard-surface rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-text-primary mb-4">üåç Timezone</h2>
        <p class="text-text-secondary mb-4">Select your timezone. All times in the dashboard will be displayed in this
            timezone.</p>

        <div class="mb-4">
            <label for="timezone-select" class="block text-sm font-medium text-text-secondary mb-2">Select your
                timezone:</label>
            <select id="timezone-select"
                class="w-full px-4 py-2 bg-dashboard-surface border border-border text-text-primary rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent">
                <option value="America/Los_Angeles">America/Los_Angeles - Pacific Time (US & Canada)</option>
                <option value="America/Denver">America/Denver - Mountain Time (US & Canada)</option>
                <option value="America/Chicago">America/Chicago - Central Time (US & Canada)</option>
                <option value="America/New_York">America/New_York - Eastern Time (US & Canada)</option>
                <option value="America/Toronto">America/Toronto - Eastern Time (Canada)</option>
                <option value="America/Vancouver">America/Vancouver - Pacific Time (Canada)</option>
                <option value="UTC">UTC - UTC (Coordinated Universal Time)</option>
                <option value="Europe/London">Europe/London - London (GMT/BST)</option>
                <option value="Europe/Paris">Europe/Paris - Paris (CET/CEST)</option>
                <option value="Asia/Tokyo">Asia/Tokyo - Tokyo (JST)</option>
                <option value="Australia/Sydney">Australia/Sydney - Sydney (AEDT/AEST)</option>
            </select>
        </div>

        <div id="timezone-preview" class="text-sm text-gray-500 mb-4"></div>

        <div id="timezone-success" class="success-message">‚úÖ Timezone saved successfully!</div>
        <div id="timezone-error" class="error-message">‚ùå Failed to save timezone. Please try again.</div>
    </div>

    <!-- Currency Settings -->
    <div class="bg-dashboard-surface rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-text-primary mb-4">üí∞ Currency</h2>
        <p class="text-text-secondary mb-4">Select your preferred display currency. All values will be converted and
            displayed in this currency.</p>

        <div class="mb-4">
            <label for="currency-select" class="block text-sm font-medium text-text-secondary mb-2">Select your display
                currency:</label>
            <select id="currency-select"
                class="w-full px-4 py-2 bg-dashboard-surface border border-border text-text-primary rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent">
                <option value="CAD">CAD - Canadian Dollar</option>
                <option value="USD">USD - US Dollar</option>
            </select>
        </div>

        <div id="currency-success" class="success-message">‚úÖ Currency saved successfully!</div>
        <div id="currency-error" class="error-message">‚ùå Failed to save currency. Please try again.</div>
    </div>

    <!-- Theme Settings -->
    <div class="bg-dashboard-surface rounded-lg shadow-lg p-6 mb-6 card-hover">
        <h2 class="text-2xl font-bold text-text-primary mb-4">üé® Theme</h2>
        <p class="text-text-secondary mb-4">Override your browser/system theme preference. 'System Default' follows your
            OS setting.</p>

        <div class="mb-4">
            <label for="theme-select" class="block text-sm font-medium text-text-secondary mb-2">Select your
                theme:</label>
            <select id="theme-select"
                class="w-full px-4 py-2 bg-dashboard-surface border border-border text-text-primary rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent">
                <option value="system">System Default</option>
                <option value="light">Light Mode</option>
                <option value="dark">Dark Mode</option>
                <option value="midnight-tokyo">Midnight Tokyo (Neon)</option>
                <option value="abyss">Abyss (Ocean)</option>
            </select>
        </div>

        <div id="theme-preview" class="text-sm text-gray-500 mb-4"></div>
        <div id="theme-success" class="success-message" style="display: none;">‚úÖ Theme saved successfully!</div>
        <div id="theme-error" class="error-message" style="display: none;">‚ùå Failed to save theme. Please try again.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module" src="/assets/js/settings.js" data-cfasync="false"></script>
<script>
    // Initialize page with current preferences
    document.addEventListener('DOMContentLoaded', function () {
        // Set current timezone
        const currentTimezone = '{{ current_timezone }}';
        const timezoneSelect = document.getElementById('timezone-select');
        if (currentTimezone && timezoneSelect) {
            // Try to set the value, log if it doesn't match
            timezoneSelect.value = currentTimezone;
            if (timezoneSelect.value !== currentTimezone) {
                console.warn(`Timezone value '${currentTimezone}' not found in options, current value: ${timezoneSelect.value}`);
            }
            updateTimezonePreview();
        }

        // Set current currency
        const currentCurrency = '{{ current_currency }}';
        const currencySelect = document.getElementById('currency-select');
        if (currentCurrency && currencySelect) {
            currencySelect.value = currentCurrency;
            if (currencySelect.value !== currentCurrency) {
                console.warn(`Currency value '${currentCurrency}' not found in options, current value: ${currencySelect.value}`);
            }
        }

        // Set current theme
        const currentTheme = '{{ current_theme }}';
        const themeSelect = document.getElementById('theme-select');
        if (currentTheme && themeSelect) {
            themeSelect.value = currentTheme;
            if (themeSelect.value !== currentTheme) {
                console.warn(`Theme value '${currentTheme}' not found in options, current value: ${themeSelect.value}`);
            }
            updateThemePreview();
        }

        // V2 Beta Toggle Handler
        const v2Toggle = document.getElementById('v2-toggle');
        if (v2Toggle) {
            v2Toggle.addEventListener('change', async function () {
                const enabled = this.checked;
                const toggleElement = this; // Capture 'this' for use in catch
                try {
                    const response = await fetch('/api/settings/v2_enabled', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ enabled: enabled })
                    });

                    if (!response.ok) {
                        const data = await response.json().catch(() => ({}));
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to update');
                    }

                    // Reload page to update navigation menu immediately
                    window.location.reload();
                } catch (error) {
                    console.error('Error updating v2_enabled:', error);
                    toggleElement.checked = !enabled; // Revert
                    const errorMsg = error.message || 'Unknown error';
                    alert('Failed to update preference: ' + errorMsg);
                    console.error('Full error details:', error);
                }
            });
        }
    });

    function updateTimezonePreview() {
        const tz = document.getElementById('timezone-select').value;
        if (tz) {
            // This would ideally show current time, but requires server-side rendering
            document.getElementById('timezone-preview').textContent = `Selected: ${tz}`;
        }
    }

    function updateThemePreview() {
        const theme = document.getElementById('theme-select').value;
        const preview = document.getElementById('theme-preview');
        if (theme === 'system') {
            preview.textContent = '‚ÑπÔ∏è Theme will follow your browser/OS dark mode setting';
        } else if (theme === 'dark') {
            preview.textContent = 'üåô Dark mode will be forced on';
        } else if (theme === 'light') {
            preview.textContent = '‚òÄÔ∏è Light mode will be forced on';
        } else if (theme === 'midnight-tokyo') {
            preview.textContent = 'üåÉ Cyberpunk neon theme';
        } else if (theme === 'abyss') {
            preview.textContent = 'üåä Deep ocean void theme';
        }
    }

    document.getElementById('timezone-select').addEventListener('change', updateTimezonePreview);
    document.getElementById('theme-select').addEventListener('change', updateThemePreview);
</script>
{% endblock %}